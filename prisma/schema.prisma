generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ===================== MODELS ===================== */

model admin_users {
  id                    String   @id @default(uuid()) @db.VarChar(36)
  email                 String   @unique(map: "email")
  password              String   @db.VarChar(255)
  name                  String?  @db.VarChar(191)
  created_at            DateTime @default(now()) @db.DateTime(6)
  updated_at            DateTime @updatedAt @db.DateTime(6)
  deleted_at            DateTime? @db.DateTime(6)
  password_changed_at   DateTime @default(now()) @db.DateTime(6)

  // relations (back-relations)
  events                events[]
  merchants             merchants[]
  partners              partners[]
  programs              programs[]
  testimonials          testimonials[]
  reset_password_tokens reset_password_tokens[]
  checkin_logs          ticket_checkin_logs[]  // ⟵ NEW

  @@map("admin_users")
}

enum events_pricing_type {
  FREE
  PAID
}

model events {
  id            String      @id @default(uuid()) @db.VarChar(36)
  admin_user_id String      @db.VarChar(36)
  title         String
  description   String      @db.Text
  start_at      DateTime    @db.DateTime(6)
  end_at        DateTime    @db.DateTime(6)
  location      String      @db.VarChar(255)
  banner_url    String      @db.VarChar(512)
  is_published  Boolean     @default(false)
  pricing_type  events_pricing_type @default(FREE)
  ticket_price  Int                 @default(0)
  capacity      Int?
  created_at    DateTime    @default(now()) @db.DateTime(6)
  updated_at    DateTime    @updatedAt @db.DateTime(6)
  deleted_at    DateTime?   @db.DateTime(6)

  admin_users   admin_users @relation(fields: [admin_user_id], references: [id], map: "fk_events_admin", onUpdate: Cascade, onDelete: Restrict)
  tickets       tickets[]

  @@index([admin_user_id], map: "idx_events_admin")
  @@index([start_at, end_at], map: "idx_events_dates")
  @@index([is_published, start_at], map: "idx_events_published_start")
  @@map("events")
}

model merchants {
  id            String      @id @default(uuid()) @db.VarChar(36)
  admin_user_id String      @db.VarChar(36)

  merchant_name String      @db.VarChar(191)
  about         String      @db.Text
  address       String      @db.Text
  email         String      @db.VarChar(191)
  phone         String      @db.VarChar(64)
  instagram     String?     @db.VarChar(191)
  twitter       String?     @db.VarChar(191)
  website       String?     @db.VarChar(191)
  mou_url       String?     @db.VarChar(191)
  image_url     String?     @db.VarChar(191)
  created_at    DateTime    @default(now()) @db.DateTime(6)
  updated_at    DateTime    @updatedAt @db.DateTime(6)
  deleted_at    DateTime?   @db.DateTime(6)

  admin_users   admin_users @relation(fields: [admin_user_id], references: [id], map: "fk_merchants_admin", onUpdate: Cascade, onDelete: Restrict)

  @@index([admin_user_id], map: "idx_merchants_admin")
  @@map("merchants")
}

model partners {
  id                   String        @id @default(uuid()) @db.VarChar(36)
  admin_user_id        String        @db.VarChar(36)
  name                 String
  slug                 String        @unique(map: "uniq_partners_slug") @db.VarChar(255)
  logo_url             String?       @db.VarChar(255)
  description          String?       @db.Text
  address              String?       @db.Text
  city                 String?       @db.VarChar(100)
  country              String        @db.VarChar(128)
  type                 partners_type
  website              String        @db.VarChar(512)
  mou_url              String?       @db.VarChar(512)
  contact              Json?
  created_at           DateTime      @default(now()) @db.DateTime(6)
  updated_at           DateTime      @updatedAt @db.DateTime(6)
  deleted_at           DateTime?     @db.DateTime(6)
  state                String?       @db.VarChar(100)
  postal_code          String?       @db.VarChar(20)
  tuition_min          Decimal?      @db.Decimal(12, 2)
  tuition_max          Decimal?      @db.Decimal(12, 2)
  living_cost_estimate Decimal?      @db.Decimal(12, 2)
  currency             String        @default("IDR") @db.Char(3)

  admin_users          admin_users   @relation(fields: [admin_user_id], references: [id], map: "fk_partners_admin", onUpdate: Cascade, onDelete: Restrict)

  @@map("partners")
}

model programs {
  id               String                    @id @default(uuid()) @db.VarChar(36)
  admin_user_id    String                    @db.VarChar(36)
  name             String
  description      String                    @db.Text
  image_url        String                    @db.VarChar(512)
  program_category programs_program_category
  price            Int?
  phone            String                    @db.VarChar(64)
  is_published     Boolean                   @default(false)
  created_at       DateTime                  @default(now()) @db.DateTime(6)
  updated_at       DateTime                  @updatedAt @db.DateTime(6)
  deleted_at       DateTime?                 @db.DateTime(6)

  admin_users      admin_users               @relation(fields: [admin_user_id], references: [id], map: "fk_programs_admin", onUpdate: Cascade, onDelete: Restrict)

  @@index([admin_user_id], map: "idx_programs_admin")
  @@index([program_category], map: "idx_programs_category")
  @@map("programs")
}

model tickets {
  id                String                 @id @default(uuid()) @db.VarChar(36)
  event_id          String                 @db.VarChar(36)
  full_name         String
  email             String
  whatsapp          String?                @db.VarChar(64)
  school_or_campus  String?
  class_or_semester String?
  domicile          String?
  ticket_code       String                 @unique(map: "uq_tickets_ticket_code") @db.VarChar(64)
  qr_url            String?                @db.VarChar(512)
  status            tickets_status         @default(PENDING)
  total_price       Int                    @default(0)
  payment_method    String?                @db.VarChar(64)
  payment_reference String?                @db.VarChar(128)
  paid_at           DateTime?              @db.DateTime(6)
  expires_at        DateTime?              @db.DateTime(6)
  checkin_status    tickets_checkin_status @default(NOT_CHECKED_IN)
  checked_in_at     DateTime?              @db.DateTime(6)
  created_at        DateTime               @default(now()) @db.DateTime(6)
  updated_at        DateTime               @updatedAt @db.DateTime(6)
  deleted_at        DateTime?              @db.DateTime(6)

  events            events                 @relation(fields: [event_id], references: [id], map: "fk_tickets_event", onUpdate: Cascade, onDelete: Restrict)
  checkin_logs      ticket_checkin_logs[]  // ⟵ NEW

  @@unique([event_id, email], map: "uq_tickets_event_email")
  @@index([checkin_status], map: "idx_tickets_checkin")
  @@index([email], map: "idx_tickets_email")
  @@index([event_id], map: "idx_tickets_event")
  @@index([status], map: "idx_tickets_status")
  @@index([checked_in_at], map: "idx_tickets_checked_in_at") // ⟵ NEW (opsional)
  @@map("tickets")
}

/// Reset password tokens (masa berlaku)
model reset_password_tokens {
  id            String      @id @default(uuid()) @db.VarChar(36)
  token         String      @unique(map: "uq_reset_password_tokens_token") @db.VarChar(128)
  expires_at    DateTime    @db.DateTime(6)
  used_at       DateTime?   @db.DateTime(6)
  created_at    DateTime    @default(now()) @db.DateTime(6)
  admin_user_id String      @db.VarChar(36)

  admin_users   admin_users @relation(fields: [admin_user_id], references: [id], map: "fk_reset_password_tokens_admin", onUpdate: Cascade, onDelete: Restrict)

  @@index([admin_user_id], map: "idx_reset_tokens_admin")
  @@index([expires_at], map: "idx_reset_tokens_expires")
  @@map("reset_password_tokens")
}

model analytics_pageviews {
  id          String   @id @default(uuid()) @db.VarChar(36)
  path        String   @db.VarChar(255)
  referrer    String?  @db.VarChar(255)
  user_agent  String?  @db.VarChar(255)
  visitor_id  String   @db.VarChar(64)
  session_id  String   @db.VarChar(64)
  created_at  DateTime @default(now()) @db.DateTime(6)

  @@index([created_at])
  @@index([visitor_id])
  @@index([session_id])
  @@index([path])
  @@map("analytics_pageviews")
}

model testimonials {
  id            String       @id @default(uuid()) @db.VarChar(36)
  admin_user_id String       @db.VarChar(36)
  name          String       @db.VarChar(100)
  photo_url     String       @db.VarChar(255)
  message       String       @db.Text
  created_at    DateTime     @default(now()) @db.DateTime(6)
  updated_at    DateTime     @updatedAt @db.DateTime(6)
  deleted_at    DateTime?    @db.DateTime(6)

  admin_user    admin_users  @relation(fields: [admin_user_id], references: [id], onUpdate: Cascade, onDelete: Restrict)

  @@index([admin_user_id], map: "idx_testimonials_admin")
  @@map("testimonials")
}

model ticket_checkin_logs {
  id         String   @id @default(uuid()) @db.VarChar(36)
  ticket_id  String   @db.VarChar(36)
  admin_id   String   @db.VarChar(36)
  created_at DateTime @default(now()) @db.DateTime(6)

  tickets     tickets     @relation(fields: [ticket_id], references: [id], map: "fk_checkin_ticket", onUpdate: Cascade, onDelete: Restrict)
  admin_users admin_users @relation(fields: [admin_id], references: [id], map: "fk_checkin_admin", onUpdate: Cascade, onDelete: Restrict)

  @@index([ticket_id])
  @@index([admin_id])
  @@index([created_at])
  @@map("ticket_checkin_logs")
}

/* ===================== ENUMS ===================== */

enum partners_type {
  DOMESTIC
  FOREIGN
}

enum programs_program_category {
  B2B
  B2C
}

enum tickets_status {
  PENDING
  CONFIRMED
  CANCELLED
}

enum tickets_checkin_status {
  NOT_CHECKED_IN
  CHECKED_IN
}
